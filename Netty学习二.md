---
title: Netty学习二
date: 2017-07-20 09:33:45
tags: Netty
---
# Netty学习二

文件传输通常采用FTP或者HTTP附件的方式。事实上通过TCP Socket+File的方式进行文件传输也有一定的应用场景，尽管不是主流，
但是掌握这种文件传输方式还是比价重要的，特别是针对两个跨主机的JVM进程之间进行持久化数据的相互交换。

## 私有协议栈开发

广义上区分，通信协议可以分为公有协议和私有协议。由于私有协议的灵活性，它往往会在某个公司或者组织内部使用，按需定制，也因为如此，升级起来会非常方便，灵活性好。

绝大多数的私有协议传输层都基于TCP/IP，所以利用Netty的NIO TCP协议栈可以非常方便地进行私有协议的定制和开发。

### Netty协议栈

Netty协议栈用于内部各模块之间的通信，它基于TCP/IP协议栈，是一个类HTTP协议的应用层协议栈，相比于传统的标准协议栈，它更加轻巧、灵活和实用。

- 主要功能

（1）基于Netty的NIO通信框架，提供高性能的异步通信能力；
（2）提供消息的编解码框架，可以实现POJO的序列化和反序列化；
（3）提供基于IP地址的白名单接入认证机制；
（4）链路的有效性校验机制；
（5）链路的断连重连机制；

### 通信模型

Netty协议栈通信模型如下：

![Netty协议栈通信交互图](http://i1.buimg.com/598959/85534a3442f7b9b6.png)

具体步骤如下：

1. Netty协议栈客户端发送握手请求消息，携带节点ID等有效身份认证信息；

2. Netty协议栈服务端对握手请求消息进行合法性校验，包括节点ID有效性校验、节点重复登录校验和IP笛之爱合法性校验，校验通过后，返回登录成功的握手应答消息；

3. 链路建立成功之后，客户端发送业务消息；

4. 链路成功之后，服务端发送心跳消息；

5. 链路建立成功之后，客户端发送心跳消息；

6. 链路建立成功之后，服务端发送业务消息；

7. 服务端退出时，服务端关闭连接，客户端感知对方关闭连接后，被动关闭客户端连接。

> Netty协议通信双方链路建立成功之后，双方可以进行全双工通信，无论客户端还是服务端，都可以主动发送请求消息给对方，通信方式可以是TWO WAY或者ONE WAY。双方之间的心跳采用Ping-Pong机制，当链路处于空闲状态时，客户端主动发送Ping消息给服务端，服务端接收到Ping消息后发送应答消息Pong给客户端，如果客户端连续发送N条Ping消息都没有接收到服务端返回的Pong消息，说明链路已经挂死或者对象处理异常状态，客户端主动关闭连接，间隔周期T后发送重连操作，直到重连成功。

### 消息定义

Netty协议栈消息定义包含两部分：

- 消息头
- 消息体

### Netty协议的编解码规范

### 链路的关闭

由于采用长连接通信，在正常的业务运行期间，双方通过心跳和业务消息维持链路，任何一方都不需要主动关闭连接。

在以下情况下，客户端和服务端需要关闭连接：
（1）当对方宕机或者重启时，会主动关闭链路，另一方读取到操作系统的通知信号，得知对方REST链路，需要关闭连接，释放自身的句柄等资源。由于采用TCP全双工通信，通信双方都需要关闭连接，释放资源。

 (2) 消息读写过程中，发生了I/O异常，需要主动关闭连接；

 (3) 心跳消息读写过程中发生了I/O异常，需要主动关闭连接；

 (4) 心跳超时，需要主动关闭连接；

 发生编码异常等不可恢复错误时，需要主动关闭连接。

### 应用Netty协议栈需要考虑的问题

安全认证
队列中消息如何处理

OpenSSL是为了网络通信提供安全及数据完整性的一种安全协议，囊括主要的密码算法、常用的密钥和整数封装管理功能以及SSL协议。多数SSL加密网站是用名为OpenSSL的开源软件包。

Netty SSL安全特性

#### SSL单向认证

单向认证，即客户端只验证服务端的合法性，服务端不验证客户端。