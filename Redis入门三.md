---
title: Redis入门（三）
date: 2017-08-03 20:10:28
tags: redis
---
# Redis入门（三）

## 集群

Redis Cluster是Redis的分布式解决方案，在3.0版本正式推出，有效地解决了Redis分布式方面的需求。当遇到单机内存、并发、流量等瓶颈时，可以采用Cluster架构方案达到负载均衡的目的。

在3.0版本之前，Redis分布式方案一般有两种：

- 客户端分区方案：优点是分区逻辑可控，缺点是需要自己处理数据路由、高可用、故障转移等问题。

- 代理方案：优点是简化客户端分布式逻辑和升级维护便利，缺点是加重架构部署复杂度和性能损耗。

### 数据分布

#### 数据分布理论

分布式数据库首先要解决把整个数据集按照**分区规则**映射到多个节点的问题，即把数据集划分到多个节点上，每个节点负责整体数据的一个子集。

常见的分区规则有哈希分区和顺序分区两种：

- 哈希分区
  - 特点
    - 离散度好
    - 数据分布业务无关
    - 无法顺序访问
  - 代表产品
    - Redis Cluster
    - Cassandra
    - Dynamo

- 顺序分区
  - 特点
    - 离散度易倾斜
    - 数据分布业务相关
    - 可顺序访问
  - 代表产品
    - Bigtable
    - Hbase
    - Hypertable

##### 常见的哈希分区

- 节点取余分区

    使用特定的数据，如Redis的键或用户ID，再根据节点数量N使用公式：hash（key）%N计算出哈希值，用来决定数据映射到哪一个节点上。这种方案存在一个问题：当节点数量变化时，如扩容或收缩节点，数据节点映射关系需要重新计算，会导致数据的重新迁移。

    这种方式的突出优点是简单性，常用于数据库的分库分表规则，一般采用预分区的方式，提前根据数据量规划好分区数，比如划分为512或1024张表，保证可支撑未来一段时间的数据量，再根据负载情况将表迁移到其他数据库中。扩容时通常采用翻倍扩容，避免数据映射全部被打乱导致全量迁移的情况，如下图所示：
 ![哈希取余.png](http://upload-images.jianshu.io/upload_images/2889214-03598bc7b6eb3190.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- 一致性哈希

    一致性哈希分区（Distributed Hash Table）实现思路是为系统中每个节
    点分配一个token，范围一般在0~2的32次方 ，这些token构成一个哈希环。

    数据读写执行节点查找操作时，先根据key计算hash值，然后顺时针找到第一个大于等于该哈希值的token节点，如图所示：
    ![一致性哈希.png](http://upload-images.jianshu.io/upload_images/2889214-ada4babca86a16fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

  这种方式相比节点取余最大的好处在于加入和删除节点只影响哈希环中相邻的节点，对其他节点无影响。但一致性哈希分区存在几个问题：

    - 加减节点会造成哈希环中部分数据无法命中，需要手动处理或者忽略这部分数据，因此一致性哈希常用于缓存场景。

    - 当使用少量节点时，节点变化将大范围影响哈希环中数据映射，因此这种方式不适合少量数据节点的分布式方案。
    
    - 普通的一致性哈希分区在增减节点时需要增加一倍或减去一半节点才能保证数据和负载的均衡。

    正因为一致性哈希分区的这些缺点，一些分布式系统采用虚拟槽对一致性哈希进行改进，比如Dynamo系统。

- 虚拟槽分区

    虚拟槽分区巧妙地使用了哈希空间，使用分散度良好的哈希函数把所有数据映射到一个固定范围的整数集合中，整数定义为槽（slot）。这个范围一般远远大于节点数，比如Redis Cluster槽范围是0~16383。槽是集群内数据管理和迁移的基本单位。采用大范围槽的主要目的是为了方便数据拆分和集群扩展。每个节点会负责一定数量的槽，如图所示：
 ![虚拟槽.png](http://upload-images.jianshu.io/upload_images/2889214-6abb45f37eab22e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

    当前集群有5个节点，每个节点平均大约负责3276个槽。由于采用高质
    量的哈希算法，每个槽所映射的数据通常比较均匀，将数据平均划分到5个节点进行数据分区。

#### Redis数据分区

Redis Cluser采用虚拟槽分区，所有的键根据哈希函数映射到0~16383整
数槽内，计算公式：slot=CRC16（key）&16383。每一个节点负责维护一部分槽以及槽所映射的键值数据。

**Redis虚拟槽分区的特点**：

- 解耦数据和节点之间的关系，简化了节点扩容和收缩难度。

- 节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据。

- 支持节点、槽、键之间的映射查询，用于数据路由、在线伸缩等场景。

**集群功能限制**：

Redis集群相对单机在功能上存在一些限制，需要开发人员提前了解，
在使用时做好规避。限制如下：

1）key批量操作支持有限。如mset、mget，目前只支持具有相同slot值的
key执行批量操作。对于映射为不同slot值的key由于执行mget、mget等操作可能存在于多个节点上因此不被支持。

2）key事务操作支持有限。同理只支持多key在同一节点上的事务操
作，当多个key分布在不同的节点上时无法使用事务功能。

3）key作为数据分区的最小粒度，因此不能将一个大的键值对象如
hash、list等映射到不同的节点。

4）不支持多数据库空间。单机下的Redis可以支持16个数据库，集群模
式下只能使用一个数据库空间，即db0。

5）复制结构只支持一层，从节点只能复制主节点，不支持嵌套树状复制结构。

### 搭建集群

搭建集群工作需要以下三个步骤：

- 准备节点

- 节点握手

- 分配槽

### 节点通信

#### 通信流程

在分布式存储中需要提供维护节点元数据信息的机制，所谓元数据是
指：节点负责哪些数据，是否出现故障等状态信息。

常见的元数据维护方式分为：集中式和P2P方式。Redis集群采用P2P的Gossip（流言）协议，
Gossip协议工作原理就是节点彼此不断通信交换信息，一段时间后所有的节
点都会知道集群完整的信息，这种方式类似流言传播。

通信过程说明：
1）集群中的每个节点都会单独开辟一个TCP通道，用于节点之间彼此
通信，通信端口号在基础端口上加10000。

2）每个节点在固定周期内通过特定规则选择几个节点发送ping消息。

3）接收到ping消息的节点用pong消息作为响应。

集群中每个节点通过一定规则挑选要通信的节点，每个节点可能知道全
部节点，也可能仅知道部分节点，只要这些节点彼此可以正常通信，最终它
们会达到一致的状态。当节点出故障、新节点加入、主从角色变化、槽信息
变更等事件发生时，通过不断的ping/pong消息通信，经过一段时间后所有的
节点都会知道整个集群全部节点的最新状态，从而达到集群状态同步的目
的。

#### Gossip消息

Gossip协议的主要职责就是信息交换。信息交换的载体就是节点彼此发
送的Gossip消息，了解这些消息有助于我们理解集群如何完成信息交换。

常用的Gossip消息可分为：ping消息、pong消息、meet消息、fail消息
等。

#### 节点选择

Redis集群内节点通信采用固定频率（定时任务每秒执行10次）。因此节点每次选择需
要通信的节点列表变得非常重要。通信节点选择过多虽然可以做到信息及时
交换但成本过高。节点选择过少会降低集群内所有节点彼此信息交换频率，
从而影响故障判定、新节点发现等需求的速度。因此Redis集群的Gossip协
议需要兼顾信息交换实时性和成本开销，通信节点选择的规则如图所示：

- 选择发送消息的节点数量

集群内每个节点维护定时任务默认每秒执行10次，每秒会随机选取5个
节点找出最久没有通信的节点发送ping消息，用于保证Gossip信息交换的随
机性。每100毫秒都会扫描本地节点列表，如果发现节点最近一次接受pong
消息的时间大于cluster_node_timeout/2，则立刻发送ping消息，防止该节点信
息太长时间未更新。

因此cluster_node_timeout参数对消息发送的节点数量影响非常大。当我们的带宽
资源紧张时，可以适当调大这个参数，如从默认15秒改为30秒来降低带宽占
用率。过度调大cluster_node_timeout会影响消息交换的频率从而影响故障转
移、槽信息更新、新节点发现的速度。因此需要根据业务容忍度和资源消耗
进行平衡。同时整个集群消息总交换量也跟节点数成正比

- 消息数据量

每个ping消息的数据量体现在消息头和消息体中，其中消息头主要占用
空间的字段是myslots[CLUSTER_SLOTS/8]，占用2KB，这块空间占用相对
固定。消息体会携带一定数量的其他节点信息用于信息交换。

## 集群伸缩

### 伸缩原理

Redis集群提供了灵活的节点扩容和收缩方案。在不影响集群对外服务
的情况下，可以为集群添加节点进行扩容也可以下线部分节点进行缩容。

Redis集群可以实现对节点的灵活上下线控制。其中原
理可抽象为槽和对应数据在不同节点之间灵活移动。

> 集群伸缩=槽和数据在节点之间的移动。

### 扩容集群



## 高可用

[Redis集群技术及Codis实践](http://www.infoq.com/cn/articles/effective-ops-part-03)
