---
title: activiti
date: 2016-10-19T09:39:32.000Z
tags: 工作流
---

工作流应用广泛，在由任务驱动的各种系统中都能见到它的身影，例如，CRM、ERP、 ECM、BI、OA等，用来处理系统运行过程中发起的业务流程。工作流总是以任务（Task）的形式驱动人处理业务或者驱动业务系统自动完成作业。

<!-- more -->

# 什么是Activiti

业务流程由多个环节串联起来并且每个环节被赋予任务，而每个任务又可以分为多个活动。 活动是业务流程中最小的组成部分。

Activiti是一个针对企业用户、开发人员、系统管理员的轻量级工作流业务管理平台，其核心是 使用Java开发的快速、稳定的BPMNN2.0流程引擎。可以运行在任何类型的Java程序中，完美地与Spring 集成。

# 工作流基础

- BPM
- 工作流生命周期 1、定义 2、发布 3、执行 4、监控 5、优化
- BPMN Business Process Modeling Notation,简称BPMN，中文译为业务流程建模标注，是由 BPMN标准组织发布的。

  BPMN定义了业务流程图，其基于流程图技术，同时对创建业务流程操作的图形化模型进行了 裁减。业务流程的模型就是图形化对象的网图，包括活动（也可以说工作）和定义操作顺序 的流控制。

- Activiti的特点<br>
  1、数据持久化<br>
  2、引擎Service接口<br>
  Activiti引擎提供了七大Service接口，均通过ProcessEngine获取，并且支持 链式API编程风格。

  - RepositoryService
  - IdentifyService
  - RuntimeService
  - TaskService
  - FormService
  - HistoryService
  - ManagementService

  3、流程设计器<br>
  4、原生支持Spring<br>
  5、分离运行时与历史数据

任务签收与办理 执行了签收动作之后任务归签收人所有。

启动流程<br>
对于scriptTask，流程引擎会自动处理，处理完成之后流转到下个节点。就目前来说， 除了userTask不能被自动处理之外，其他的任务均由流程引擎自动处理，无需人工参与。

设计流程 1、设置流程属性

## BPMN2.0规范

### 启动事件与结束事件

1、空启动事件 2、定时启动事件 3、异常启动事件

> 启动事件都是"捕获型"的，等待第三方触发后才可以启动。

##### 异常启动事件
  异常启动事件不能用于主流程，必须嵌入到事件子流程中。

## Java规则引擎----drools

## 消息路由框架----Camel

## ESB框架----Mule

### 调用活动和子流程

### 事件子流程

### 事务子流程

事务子流程也称为"事务块"，用来处理一组必须在同一个事务中完成的活动，这些活动要么一起成功，要么一起失败，事务子流程中的活动具有ACID特性。

### 监听器

#### 执行监听器

#### 任务监听器

只能应用于用户任务，用来监听3种事件。

- create
- assignment
- complete

TDD开发


### 用户与组
  组与用户的关系是多对多。在各种需要人工参与的系统中，用户和组是一个身份系统（或者模块）
的基础，在Activiti中用户和组主要是应用于用户任务。   

  组是控制权限的一种方式，属于某个组的用户就拥有操作某些功能的权限。在Activiti中，组的类型
分为两种，即assignment和security-role,前者为一种普通的岗位角色，是用户分配业务中的功能权限，后者是安全角色，可以从全局管理用户组织及整个流程的状态。

** 组与用户建立关联关系：**
```java

```  

** 用户任务中用户与组 **  
** 1、候选组 **  
当不确认要将一个任务分配给哪个人办理时，就需要把任务指定给多个候选组。

候选组与候选人的区别：
  候选组包含候选人，所有属于候选组中的用户都可以理解为“候选人”。


** 2、部署流程资源 **
流程资源可以是各种类型的文件，在启动流程或流程实例运行过程中会被读取。

要用流程驱动业务就必须为业务启动一个流程实例，启动一个流程实例就必须定义一系列活动，这一系列活动就组成了一个流程定义。

> 只能在已部署的流程定义启动流程实例

部署流程资源的方式
- classpath方式
  classpath方式的路径名规范是用斜杠“/”方式分割多个包名。
- InputStream方式  
- 字符串方式
- zip/bar格式压缩包方式

### 流程定义图片
  一个流程定义会对应一个图片资源。图片可以由引擎自动生成，或者与流程定义一起部署（压缩包方式），这样引擎不再自动生成图片资源，而是使用部署包中的图片资源。

  流程图片可以让用户清楚整个流程需要处理的任务及流程的走向，可以在流程运行过程中
显示地跟踪流程处理的进度。
### 任务表单
提交表单字段并启动一个新的流程实例
```java
public ProcessInstance submitStartFormData(String processDefinitionId, Map<String, String> properties) {
    return commandExecutor.execute(new SubmitStartFormCmd(processDefinitionId, null, properties));
}
```  

任务签收与办理
** 代办任务的数据来源 **  
- 直接分配  
  直接通过humanPerformer元素或activiti:assinee属性指定某个人的ID作为任务班里人。

- 候选人范围之内
- 属于某个候选组
- 代办任务

转办
  把一个任务的办理人重新分配给其他的用户的过程称为转办。  



会签  
设置结束条件


#### 子流程与调用活动


#### 用户任务
在不签收任务的情况下可以查看任务表单

#### 反签收任务
  反签收时相对于签收动作来说的，顾名思义，可以把已经签收的任务的班里人置空，这样任务又还原到未签收
状态，此功能对于日常使用中误签收的情况非常有用。
```
 taskService.claim(taskId,null); // 反签收，第二个参数为空。
```

在执行反签收时有一点要特别注意，如果用户任务没有相关候选人与侯选组，执行反签收动作会导致任务
无人认领（可以理解未游离状态），所以在反签收时要判断该任务是否满足反签收条件。


#### 管理员特性
- 用户与组：一般的系统中都配有统一的用户模块。 
- 流程状态：包括流程定义、流程实例、任务。
- 作业管理：可以监管定时或异步的作业任务。
- 数据库：可以直接通过系统查看数据库的记录。

#### 流程定义权限控制




#### 业务和流程的关联方式

对于无论是Activtit还是jbpm来说，业务与流程的整合均类似，启动流程是绑定业务，流程与业务的整合放到动态代理中。



#### 各种状态的任务查询以及和业务对象关联
我们目前分为4中状态：未签收、办理中、运行中、已完成。
查询到任务或者流程实例后要显示在页面，这个时候需要添加业务数据，最终结果就是业务和流程的并集。





https://github.com/henryyan/activiti-study.git


#### Activiti数据库表结构
##### 数据库表名说明
    Activiti工作流总共包含23张数据表，所有的表名默认以“ACT_”开头。并且表名的第二部分用两个字母表明表的用例，而这个用例也基本上跟Service API匹配。
- ACT_GE_* : “GE”代表“General”（通用），用在各种情况下；
- ACT_HI_* : “HI”代表“History”（历史），这些表中保存的都是历史数据，比如执行过的流程实例、变量、任务，等等。Activit默认提供了4种历史级别：  
      **none:** 不保存任何历史记录，可以提高系统性能；  
      **activity：** 保存所有的流程实例、任务、活动信息；  
      **audit：** 也是Activiti的默认级别，保存所有的流程实例、任务、活动、表单属性；  
      **full：** 最完整的历史记录，除了包含audit级别的信息之外还能保存详细，例如：流程变量。  
对于几种级别根据对功能的要求选择，如果需要日后跟踪详细可以开启full。
 
- ACT_ID_* : “ID”代表“Identity”（身份），这些表中保存的都是身份信息，如用户和组以及两者之间的关系。如果Activiti被集成在某一系统当中的话，这些表可以不用，可以直接使用现有系统中的用户或组信息；
- ACT_RE_* : “RE”代表“Repository”（仓库），这些表中保存一些‘静态’信息，如流程定义和流程资源（如图片、规则等）；
- ACT_RU_* : “RU”代表“Runtime”（运行时），这些表中保存一些流程实例、用户任务、变量等的运行时数据。Activiti只保存流程实例在执行过程中的运行时数据，并且当流程结束后会立即移除这些数据，这是为了保证运行时表尽量的小并运行的足够快；

# Activiti数据表清单
**一般数据**
  - ACT_GE_BYTEARRAY  
    通用的流程定义和流程资源
  - ACT_GE_PROPERTY  
    系统相关属性  

**流程历史记录**
  - ACT_HI_ACTINST  
    历史的流程实例
  - ACT_HI_ATTACHMENT  
    历史的流程附件
  - ACT_HI_COMMENT  
  	历史的说明性信息
  - ACT_HI_DETAIL  
    历史的流程运行中的细节信息 
  - ACT_HI_IDENTITYLINK  
    历史的流程运行过程中用户关系
  - ACT_HI_PROCINST  
    历史的流程实例
  - ACT_HI_TASKINST   
    历史的任务实例
  - ACT_HI_VARINST   
    历史的流程运行中的变量信息

 **用户用户组表**
  - ACT_ID_GROUP  
    身份信息-组信息
  - ACT_ID_INFO  
    身份信息-组信息
  - ACT_ID_MEMBERSHIP  
    身份信息-用户和组关系的中间表
  - ACT_ID_USER  
    身份信息-用户信息

 **流程定义表**
  - ACT_RE_DEPLOYMENT  
    部署单元信息
  - ACT_RE_MODEL
    模型信息
  - ACT_RE_PROCDEF 
    已部署的流程定义

  **运行实例表**
   - ACT_RU_EVENT_SUBSCR  
     运行时事件
   - ACT_RU_EXECUTION  
     运行时流程执行实例
   - ACT_RU_IDENTITYLINK  
     运行时用户关系信息
   - ACT_RU_JOB  
     运行时作业
   - ACT_RU_TASK 
     运行时任务
   - ACT_RU_VARIABLE
     运行时变量表   

    
# 工单系统
工单系统用于记录、处理、跟踪一项工作的完成情况。提供系统化、标准化的工作处理流程。用于企业间和企业内部的工作协作，具有批量性、
时效性、绩效性的特点。

工单系统一般被广泛用于客户帮助支持服务，客户售后服务，企业IT支持服务，呼叫中心等，用来创建，挂起，解决用户，客户，合作伙伴或企业内部职员提交的事务请求。规范化，统一化和清晰化的处理和管理事务。一个完整的工单系统还需要配套拥有一个帮助文档知识库（Knowledge base）,里面包含客户的一些常见受理问题相关信息，常见问题的处理方式，和一些其他的帮助文档等。一个工单系统就像一个问题追踪器，能很清晰的追踪，处理和归档内外的问题事务请求，标准化服务追踪用户。


# 表单与流程整合
在表单与流程的整合中，我们一般不建议把表单的所有数据都存储在流程中，仅需要把参与流程跳转的数据才存到流程变量中去。

## 在线流程表单设计逻辑结构分析
![在线流程表单设计逻辑结构分析](http://dl.iteye.com/upload/attachment/0076/4962/116f9979-7aa7-3399-ac0e-d9d549e8b342.jpg)

## 流程定义与业务表单绑定
流程定义允许绑定多种业务表单，目前我们可以简单分为三种模式，在线表单、同系统的定制业务表单、第三方业务表单。
